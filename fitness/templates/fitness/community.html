{% extends 'fitness/base.html' %}

{% block title %}Community{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold text-white mb-6">Community</h1>
  
  <div class="bg-gray-800 rounded-lg shadow-xl border border-gray-700 overflow-hidden">
    <div class="bg-blue-800 text-white p-4">
      <h2 class="text-xl font-bold">{% if user.is_superuser %}Admin Dashboard{% else %}Chat with Admin{% endif %}</h2>
    </div>
    
    <div class="grid grid-cols-1 {% if user.is_superuser %}md:grid-cols-4{% endif %}">
      <!-- Left panel for superuser to show all users -->
      {% if user.is_superuser %}
      <div class="md:col-span-1 border-r border-gray-700">
        <div class="p-4 bg-gray-700">
          <h3 class="font-medium text-white">Users</h3>
        </div>
        <div class="overflow-y-auto max-h-[70vh]">
          <ul>
            {% for other_user in all_users %}
            <li>
              <a href="{% url 'community' %}?user_id={{ other_user.id }}" 
                 class="block px-4 py-3 hover:bg-gray-700 {% if selected_user.id == other_user.id %}bg-gray-700{% endif %} border-b border-gray-700 transition duration-300">
                <div class="flex items-center">
                  <div class="bg-blue-600 rounded-full w-8 h-8 flex items-center justify-center text-white font-medium mr-3">
                    {{ other_user.username|first|upper }}
                  </div>
                  <div class="text-gray-200">{{ other_user.username }}</div>
                </div>
              </a>
            </li>
            {% empty %}
            <li class="px-4 py-3 text-gray-400">No users found</li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endif %}
      
      <!-- Right panel for chat -->
      <div class="{% if user.is_superuser %}md:col-span-3{% endif %} flex flex-col h-[70vh]">
        <!-- Chat header -->
        <div class="p-4 bg-gray-700 border-b border-gray-600 flex items-center justify-between">
          <!-- Left part with user info -->
          <div class="flex items-center">
            {% if user.is_superuser %}
              {% if selected_user %}
                <div class="bg-blue-600 rounded-full w-10 h-10 flex items-center justify-center text-white font-medium mr-3">
                  {{ selected_user.username|first|upper }}
                </div>
                <h3 class="font-medium text-white">{{ selected_user.username }}</h3>
              {% else %}
                <h3 class="font-medium text-gray-400">Select a user to start chatting</h3>
              {% endif %}
            {% else %}
              {% if admin_user %}
                <div class="bg-blue-600 rounded-full w-10 h-10 flex items-center justify-center text-white font-medium mr-3">
                  {{ admin_user.username|first|upper }}
                </div>
                <h3 class="font-medium text-white">{{ admin_user.username }}</h3>
              {% else %}
                <h3 class="font-medium text-gray-400">No admin available</h3>
              {% endif %}
            {% endif %}
          </div>

          <!-- Right part with connection status -->
          <div>
            <span class="text-sm">Status: </span>
            <span id="connection-status" class="text-yellow-500">Connecting...</span>
          </div>
        </div>
        
        <!-- Chat messages -->
        <div class="flex-1 p-4 overflow-y-auto bg-gray-800" id="chat-messages">
          {% if chat_messages %}
            {% for message in chat_messages %}
              <div class="mb-4 {% if message.sender == user %}flex justify-end{% endif %}">
                <div class="{% if message.sender == user %}bg-blue-600 text-white rounded-tl-lg rounded-tr-lg rounded-bl-lg{% else %}bg-gray-700 text-gray-200 rounded-tr-lg rounded-tl-lg rounded-br-lg{% endif %} py-2 px-4 max-w-[80%]">
                  <p>{{ message.message }}</p>
                  <p class="text-xs {% if message.sender == user %}text-blue-200{% else %}text-gray-400{% endif %} mt-1 text-right">
                    {{ message.timestamp|date:"M d, g:i a" }}
                  </p>
                </div>
              </div>
            {% endfor %}
          {% else %}
            {% if user.is_superuser and not selected_user %}
              <div class="flex items-center justify-center h-full">
                <p class="text-gray-400">Select a user to start chatting</p>
              </div>
            {% else %}
              <div class="flex items-center justify-center h-full">
                <p class="text-gray-400">No messages yet. Start the conversation!</p>
              </div>
            {% endif %}
          {% endif %}
        </div>
        
        <!-- Message input -->
        <div class="p-4 border-t border-gray-700">
          {% if user.is_superuser and selected_user or not user.is_superuser and admin_user %}
            <form id="message-form" class="flex items-center">
              {% csrf_token %}
              <input type="hidden" id="receiver-id" value="{% if user.is_superuser %}{{ selected_user.id }}{% else %}{{ admin_user.id }}{% endif %}">
              <input type="text" id="message-input" placeholder="Type your message..." class="flex-1 bg-gray-700 border border-gray-600 rounded-l-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-r-lg transition duration-300">
                <i class="fas fa-paper-plane"></i>
              </button>
            </form>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // WebSocket connection
  let chatSocket = null;
  let receiverId = {% if user.is_superuser and selected_user %}{{ selected_user.id }}{% elif not user.is_superuser and admin_user %}{{ admin_user.id }}{% else %}null{% endif %};
  const userId = {{ user.id }};
  
  document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Connect to WebSocket
    connectWebSocket();
    
    // Setup message form submission
    setupMessageForm();
  });
  
  function connectWebSocket() {
    // Close any existing connection
    if (chatSocket && chatSocket.readyState !== WebSocket.CLOSED) {
        chatSocket.close();
    }

    const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const wsUrl = `${wsProtocol}${window.location.host}/ws/${userId}/`;
    
    console.log("Attempting to connect to WebSocket at:", wsUrl);
    
    try {
        chatSocket = new WebSocket(wsUrl);
        
        chatSocket.onopen = function(e) {
            console.log('WebSocket connection established successfully!');
            document.getElementById('connection-status').textContent = 'Connected';
            document.getElementById('connection-status').className = 'text-green-500';
        };
        
        chatSocket.onmessage = function(e) {
            console.log('Message received:', e.data);
            
            try {
                const data = JSON.parse(e.data);
                
                if (data.type === 'message') {
                    console.log('Received chat message:', data);
                    // Check if this message is relevant to the current chat
                    if ((data.sender_id == receiverId && data.receiver_id == userId) || 
                        (data.sender_id == userId && data.receiver_id == receiverId)) {
                        // Add message to the chat directly
                        addMessageToChat(data);
                    }
                }
            } catch (error) {
                console.error('Error processing message:', error);
            }
        };
        
        chatSocket.onclose = function(e) {
            console.log('WebSocket connection closed');
            document.getElementById('connection-status').textContent = 'Disconnected';
            document.getElementById('connection-status').className = 'text-red-500';
            
            // Try to reconnect after a delay
            setTimeout(function() {
                connectWebSocket();
            }, 5000);
        };
        
        chatSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
            document.getElementById('connection-status').textContent = 'Error';
            document.getElementById('connection-status').className = 'text-red-500';
        };
    } catch (error) {
        console.error('Error creating WebSocket:', error);
        document.getElementById('connection-status').textContent = 'Failed to connect';
        document.getElementById('connection-status').className = 'text-red-500';
        
        // Try to reconnect after a delay
        setTimeout(function() {
            connectWebSocket();
        }, 5000);
    }
  }
  
  function addMessageToChat(messageData) {
    const chatMessages = document.getElementById('chat-messages');
    const isFromCurrentUser = messageData.sender_id == userId;
    
    // Create message element
    const messageElement = document.createElement('div');
    messageElement.className = `mb-4 ${isFromCurrentUser ? 'flex justify-end' : ''}`;
    
    // Format the timestamp
    const timestamp = new Date(messageData.timestamp);
    const formattedTime = timestamp.toLocaleString('en-US', { 
      month: 'short', 
      day: 'numeric', 
      hour: 'numeric', 
      minute: 'numeric',
      hour12: true 
    });
    
    // Set message content
    messageElement.innerHTML = `
      <div class="${isFromCurrentUser ? 'bg-blue-600 text-white rounded-tl-lg rounded-tr-lg rounded-bl-lg' : 'bg-gray-700 text-gray-200 rounded-tr-lg rounded-tl-lg rounded-br-lg'} py-2 px-4 max-w-[80%]">
        <p>${messageData.message}</p>
        <p class="text-xs ${isFromCurrentUser ? 'text-blue-200' : 'text-gray-400'} mt-1 text-right">
          ${formattedTime}
        </p>
      </div>
    `;
    
    // Add to chat and scroll to bottom
    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
  
  function setupMessageForm() {
    const messageForm = document.getElementById('message-form');
    
    if (messageForm) {
      messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();
        receiverId = document.getElementById('receiver-id').value;
        
        if (message && receiverId && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
          // Clear input first for better user experience
            messageInput.value = '';
            
          // Send message via WebSocket
          chatSocket.send(JSON.stringify({
            'type': 'message',
            'to': receiverId,
            'message': message
          }));
        } else {
          console.error("Cannot send message - WebSocket not connected or message empty");
        }
      });
    }
  }
</script>
{% endblock %} 